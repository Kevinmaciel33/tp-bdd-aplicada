--1) PRIMER REPORTE- FLUJO DE CAJA SEMANAL
--RECAUDACION POR PAGOS ORDINARIOS Y EXTRAORDINARIOS DE CADA SEMANA 
--PROMEDIO SEMANAL
--ACUMULADO PROGRESIVO

CREATE OR ALTER PROCEDURE sp_reporte_flujo_caja
	@FechaInicio DATE,
	@FechaFin DATE,
	@IdConsorcio INT
AS
BEGIN
	SELECT
		DATEPART(WEEK, p.FechaPago) AS Semana, 
		SUM(CASE WHEN de.TipoGasto = 'O' THEN p.Importe ELSE 0 END) AS TotalOrdinario,
		SUM(CASE WHEN de.TipoGasto = 'E' THEN p.importe ELSE 0 END) AS TotalExtraordinario,
		SUM(p.importe) AS TotalSemanal,
		AVG(SUM(p.importe)) OVER() AS PromedioGeneral, 
		SUM(SUM(p.importe)) OVER(ORDER BY DATEPART(WEEK, p.FechaPago)) AS Acumulado
	FROM dbo.Pago p
	INNER JOIN dbo.DetalleExpensa de ON p.IdDetalleExp = de.IdDetalle
	INNER JOIN dbo.Expensa e ON e.IdExpensa = de.IdExpensa
	WHERE e.IdConsorcio = @IdConsorcio
	 AND p.FechaPago BETWEEN @FechaInicio AND @FechaFin
	GROUP BY DATEPART(WEEK, p.FechaPago)
	ORDER BY Semana;
END
GO
--Para un consorcio especifico
--Analiza los pagos de un consorcio en un rango de fechas y los agrupa por semana
--TotalOrdinario: suma de pagos de gastos ordinarios (o) en esa semana
--TotalExtraordinario: suma de pagos de gastos extraordinarios (e) en esa semana
--TotalSemanal: suma de todos los pagos de esa semana
--PromedioGeneral: Promedio de todas las semanas (el mismo valor en todas las filas)
--Acumulado: Suma acumulada semana a semana (va sumando los totales progresivamente)

--Tablas que usa son 3: Pago, DetalleExpensa (para tipo O o E) y Expensa (tiene el consorcio)
--Filtros: solo pagos del consorcio especificado y solo pagos entre las fechas fechaini y fechafin
--INNER JOIN DE LAS 3 TABLAS
--Se agrupan por semana y se ordenan por semana


